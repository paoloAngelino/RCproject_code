## Methods

We applied a machine learning approach to identify genes associated to response to treatment, and to find a list of genes that could be potential predictors of response to Neoadjuvant Chemoradiotherapy in Locally Advanced Rectal Cancer
### Data preprocessing. 
As a first step to integrate the data, we re-annotated microarray probes by aligning probe sequences against a recent common annotation (gencode28). It has been shown that manufacturer’s annotation can vary over time and may differ from recent sources, making this a necessary step to reduce technical variation11. The expression of each gene was mean-centered and an algorithm for removal of unwanted variance (RUV) was applied with CRC specific control genes, before putting all datasets together12.  
This approach successfully attenuated the batch effect within the microarray datasets. However, merging these with the datasets profiled by high throughput sequencing (RNAseq) proved to be hard, and a batch effect correction was not possible without excessive loss of information. Indeed, the distribution of the expression in the high throughput sequencing data is very different from that of the microarray data. We resolved to a more conservative approach, and we applied a log2(x+1) transformation to the raw counts followed by mean centering and standardization.  
### Differential gene expression analyis and feature selection
We have run a differential gene expression analysis as a first exploratory analysis, and in order to select a reduce number of genes (feature selection) to supply to the machine learning models. We compared responders versus non responders. For increasing the separation power between the two groups, we have excluded the   mid responders (TRG 2) from the analysis. 410 samples were finally retained.  
Being aware of the risk of overfitting, we have cross-validated all the following steps.   
To test for differential gene expression, we have run a GLM model from the ‘limma’ R package [Ritchie ME, Phipson B, Wu D, Hu Y, Law CW, Shi W, Smyth GK (2015). “limma powers differential expression analyses for RNA-sequencing and microarray studies.” Nucleic Acids Research, 43(7), e47. doi:10.1093/nar/gkv007.] inside a cross-validation loop. The data was split in split in 10 folds using the function createFolds from the ‘caret’ R package [uhn, Max (2008). “Building Predictive Models in R Using the caret Package.” Journal of Statistical Software, 28(5), 1–26. doi:10.18637/jss.v028.i05, https://www.jstatsoft.org/index.php/jss/article/view/v028i05.]. The random sampling was performed within the two groups of the response variable, in an attempt to balance the class distributions between the splits). In each run, we combined 8 out of 10 folds (for a total of 45 runs).   
We included the batch as a covariate in the formula for the GLM model (~ batch + response).  
Finally, we computed the maximum and average p-value of all the runs, for each gene. Imposing a threshold on the maximum p-value is equivalent to computing the intersection all the signific	ant genes in each run. This method provides a set of high confidence differentially expressed genes.  
As input for the machine learning models, we opted for a less stringent selection of genes, imposing a threshold of 0.05 on the average (over the cross-validation runs) p-value. This choice is motivated by the idea of giving a larger search space to ML algorithms like glmnet [Friedman J, Tibshirani R, Hastie T (2010). “Regularization Paths for Generalized Linear Models via Coordinate Descent.” Journal of Statistical Software, 33(1), 1–22. doi:10.18637/jss.v033.i01.], which provide an internal feature selection mechanism.  
The above procedure was applied to the 6 datasets together at first, and then a second time to only 4 datasets. These 4 datasets (LIST) had a more coherent annotation system and constitute a cleaner set for the analysis.  
Finally, we intersected the lists of differential expression genes from the two analyses (6 datasets and 4 datasets), obtaining a list of 186 genes that we fed to two ML algorithms, to assess their power to predict response to treatment in the chosen datasets.  
### Machine learning
We tested two classifier algorithms to predict the response to treatment.  glmnet and Random Forest[Wright MN, Ziegler A (2017). “ranger: A Fast Implementation of Random Forests for High Dimensional Data in C++ and R.” Journal of Statistical Software, 77(1), 1–17. doi:10.18637/jss.v077.i01.] methods have been evaluated with Area Under the ROC Curve (AUC) as a measure of the model performance.   
As input to the ML algorithms, we provided the mean centered and standardized expression of the 186 genes selected with the differential expression analysis.  As for the former analysis, mid responders (TRG 2) were excluded.   
For each method, we have run a 5 folds cross-validation. The patients were split in 5 folds, and at each iteration 4 folds were used as a training set, and the out of the bag fold was used as a test set. For each method, we obtained 5 model and 5 measure of the performance. We estimated the performance of each method and of ours selected set of genes taking the average and standard deviation (for the confidence interval) of the AUC from each cross-validation iteration.   


